INSTRUCTIONS FOR FIXING DUPLICATE MOVE OUTPUT:

The HasBeenWritten field has already been added to MoveNode in PgnParser.cs:
    public bool HasBeenWritten { get; set; } = false;

Now you need to make these changes to OpeningBuilderForm.cs:

1. ADD this method right after GeneratePgn (around line 1025):

        private void ResetWrittenFlags(MoveNode node)
        {
            if (node == null) return;
            
            node.HasBeenWritten = false;
            
            foreach (var child in node.NextMoves)
            {
                ResetWrittenFlags(child);
            }
        }

2. MODIFY GeneratePgn method to call ResetWrittenFlags at the start:

        private string GeneratePgn(MoveNode root)
        {
            // Reset all HasBeenWritten flags before generating PGN
            ResetWrittenFlags(root);
            
            var sb = new StringBuilder();
            sb.AppendLine("[Event \"Opening Repertoire\"]");
            sb.AppendLine($"[White \"{(theodorePlaysWhite ? \"Theodore\" : \"Opponent\")}\"]");
            sb.AppendLine($"[Black \"{(theodorePlaysWhite ? \"Opponent\" : \"Theodore\")}\"]");
            sb.AppendLine();
            
            WriteMovesPgn(root, sb);
            sb.AppendLine(" *");
            
            return sb.ToString();
        }

3. MODIFY WriteMovesPgn to check/set the flag (around line 1050):

   At the START of WriteMovesPgn, add after getting mainline:
   
            // Get mainline move
            var mainline = node.NextMoves[0];
            
            // CHECK: Skip if already written
            if (mainline.HasBeenWritten)
            {
                Debug.WriteLine($"  SKIPPING already written: {mainline.San}");
                return;
            }
            
            bool moveByWhite = !mainline.isWhiteTurn;

   Then BEFORE writing the move (before sb.Append), add:
   
            // Mark as written before appending
            mainline.HasBeenWritten = true;
            
            // Write the mainline move
            if (chkDebugOutput.Checked)
                File.AppendAllText(@"C:\data\debug.txt", $"MAIN: {moveNum}{mainline.San}\n");

4. MODIFY WriteVariationPgn similarly (around line 1180):

   At the START, add after determining moveByWhite:
   
            bool moveByWhite = !node.isWhiteTurn;
            
            // CHECK: Skip if already written
            if (node.HasBeenWritten)
            {
                Debug.WriteLine($"  SKIPPING already written variation: {node.San}");
                return;
            }

   Then BEFORE writing the move (before sb.Append), add:
   
            // Mark as written before appending
            node.HasBeenWritten = true;
            
            // Write this move
            if (chkDebugOutput.Checked)
                File.AppendAllText(@"C:\data\debug.txt", $"VAR: {moveNum}{node.San}\n");

This will prevent any move from being written twice, which is much simpler than tracking afterVariations!
